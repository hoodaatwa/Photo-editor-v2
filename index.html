<!DOCTYPE html>
<html>
<head>


<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>

<link href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" rel="stylesheet"/>

<style>
    #image {
        max-width: 100%; /* تعديل حسب الحاجة */
        max-height: 200px; /* تعديل حسب الحاجة */
        display: block; /* يمكنك تعديل هذا لتناسب تخطيطك */
    }
</style>
    
    <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>


    <title>محرر الصور</title>
    <style>
        canvas {
            border: 1px solid #cccccc;
        }
    </style>
</head>
<body>
    <h2>محرر الصور بسيط</h2>
    <input type="file" id="imageLoader" name="imageLoader"/>

<button id="size800x600">800x600</button>
<button id="size1024x768">1024x768</button>
<button id="customSize">حجم مخصص</button>
<input type="number" id="customWidth" placeholder="عرض"/>
<input type="number" id="customHeight" placeholder="ارتفاع"/>


<label for="fontFamily">Font Family:</label>
<select id="fontFamily">
    <!-- سيتم تعبئة هذه القائمة ديناميكياً -->
</select>

<label for="textColor">Text Color:</label>
<input type="color" id="textColor" value="#000000">

<label for="backgroundColor">Background Color:</label>
<input type="color" id="backgroundColor" value="#ffffff">

<button id="addText">أضف نص</button>

<button id="undo">تراجع</button>
<button id="redo">إعادة</button>
<button id="saturation">زيادة التشبع</button>

<button id="grayscale">الأبيض والأسود</button>
<button id="brightness">زيادة السطوع</button>
<button id="contrast">زيادة التباين</button>
<button id="blur">ضبابية</button>


<button id="resize">تغيير حجم الصورة</button>

<button id="exportImage">تصدير الصورة</button>

<button id="cropImage">قص الصورة</button>

<div id="imageContainer" style="width: 100%; max-height: 400px; margin: auto; overflow: hidden;">
    
<img id="image" style="display: none;"/>


</div>


    <canvas id="imageCanvas" width="300" height="200"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <script>
var canvas = new fabric.Canvas('imageCanvas');
document.getElementById('imageLoader').addEventListener('change', function (e) {
    var reader = new FileReader();
    reader.onload = function (event) {
        var imgObj = new Image();
        imgObj.src = event.target.result;
        imgObj.onload = function () {
            var image = new fabric.Image(imgObj);
            image.set({
                angle: 0,
                padding: 10,
                cornersize: 10,
                height: imgObj.height,
                width: imgObj.width,
            });
            canvas.clear();
            canvas.add(image);
            canvas.sendToBack(img);
            canvas.setActiveObject(image);
        }
    }
    reader.readAsDataURL(e.target.files[0]);
});


// Enable drawing
var drawingModeEl = document.createElement('button');
drawingModeEl.textContent = 'Toggle Drawing Mode';
drawingModeEl.onclick = function() {
    canvas.isDrawingMode = !canvas.isDrawingMode;
    if (canvas.isDrawingMode) {
        drawingModeEl.textContent = 'Cancel Drawing Mode';
    } else {
        drawingModeEl.textContent = 'Toggle Drawing Mode';
    }
};
document.body.appendChild(drawingModeEl);




document.addEventListener('DOMContentLoaded', function() {
    // إضافة التحكمات إلى الصفحة
    const controls = document.createElement('div');
    controls.innerHTML = `
        <label for="strokeColor">لون الخط:</label>
        <input type="color" id="strokeColor" value="#000000">
        
        <label for="lineWidth">سمك الخط:</label>
        <input type="range" id="lineWidth" min="1" max="10" value="1">
        
        
    `;
    document.body.appendChild(controls);

    // تطبيق التغييرات على الرسم
    document.getElementById('strokeColor').addEventListener('change', function(e) {
        canvas.freeDrawingBrush.color = e.target.value;
    });

    document.getElementById('lineWidth').addEventListener('input', function(e) {
        canvas.freeDrawingBrush.width = parseInt(e.target.value, 10);
    });

    
});


// تطبيق الأبيض والأسود
document.getElementById('grayscale').addEventListener('click', function() {
    var obj = canvas.getActiveObject();
    if (!obj) return alert('الرجاء اختيار صورة');
    obj.filters.push(new fabric.Image.filters.Grayscale());
    obj.applyFilters();
    canvas.renderAll();
});

// زيادة السطوع
document.getElementById('brightness').addEventListener('click', function() {
    var obj = canvas.getActiveObject();
    if (!obj) return alert('الرجاء اختيار صورة');
    var filter = new fabric.Image.filters.Brightness({
        brightness: 0.05 // قيمة زيادة السطوع، قد تحتاج لتعديلها
    });
    obj.filters.push(filter);
    obj.applyFilters();
    canvas.renderAll();
});

// زيادة التباين
document.getElementById('contrast').addEventListener('click', function() {
    var obj = canvas.getActiveObject();
    if (!obj) return alert('الرجاء اختيار صورة');
    var filter = new fabric.Image.filters.Contrast({
        contrast: 10 // قيمة زيادة التباين، قد تحتاج لتعديلها
    });
    obj.filters.push(filter);
    obj.applyFilters();
    canvas.renderAll();
});

let state = [];
let mods = 0;

function updateState() {
    // Save the current state
    state.push(JSON.stringify(canvas));
}

canvas.on('object:modified', function() {
    updateState();
    mods = 0;
});


// تحميل الخطوط من Google Fonts
const googleFontsApiKey = 'AIzaSyDtlPDPq48xcOYSGnS4bv3UKLWZk-YSSlg'; // استبدل بمفتاح API الخاص بك
fetch(`https://www.googleapis.com/webfonts/v1/webfonts?key=${googleFontsApiKey}`)
    .then(response => response.json())
    .then(data => {
        const fontFamilySelect = document.getElementById('fontFamily');
        data.items.forEach(font => {
            const option = document.createElement('option');
            option.value = font.family;
            option.textContent = font.family;
            fontFamilySelect.appendChild(option);
        });
    })
    .catch(error => console.error('Error loading Google Fonts:', error));

document.getElementById('addText').addEventListener('click', function() {
    var fontFamily = document.getElementById('fontFamily').value;
    var textColor = document.getElementById('textColor').value;
    var backgroundColor = document.getElementById('backgroundColor').value;

    // استخدام WebFont لتحميل الخط المختار
    WebFont.load({
        google: {
            families: [fontFamily]
        },
        active: function() {
            // إضافة نص بالخط المحمل
            var text = new fabric.IText('اكتب هنا...', {
                left: 100,
                top: 100,
                fontFamily: fontFamily,
                fill: textColor,
                backgroundColor: backgroundColor
            });
            canvas.add(text);
        }
    });
});



document.getElementById('undo').addEventListener('click', function() {
    if (mods < state.length) {
        canvas.clear().renderAll();
        canvas.loadFromJSON(state[state.length - 1 - mods - 1]);
        canvas.renderAll();
        mods += 1;
    }
});

document.getElementById('redo').addEventListener('click', function() {
    if (mods > 0) {
        canvas.clear().renderAll();
        canvas.loadFromJSON(state[state.length - 1 - mods + 1]);
        canvas.renderAll();
        mods -= 1;
    }
});

document.getElementById('saturation').addEventListener('click', function() {
    var obj = canvas.getActiveObject();
    if (!obj) return alert('الرجاء اختيار صورة');
    var filter = new fabric.Image.filters.Saturation({
        saturation: 0.3 // زيادة التشبع، قد تحتاج لتعديلها
    });
    obj.filters.push(filter);
    obj.applyFilters();
    canvas.renderAll();
});

updateState();


document.getElementById('resize').addEventListener('click', function() {
    var obj = canvas.getActiveObject();
    if (!obj) return alert('الرجاء اختيار صورة');
    // تغيير حجم إلى 50% من الحجم الأصلي كمثال
    obj.scaleX /= 2;
    obj.scaleY /= 2;
    obj.setCoords();
    canvas.renderAll();
    updateState();
});


document.getElementById('blur').addEventListener('click', function() {
    var obj = canvas.getActiveObject();
    if (!obj) return alert('الرجاء اختيار صورة');
    var filter = new fabric.Image.filters.Blur({
        blur: 0.5 // قيمة الضبابية، قد تحتاج لتعديلها
    });
    obj.filters.push(filter);
    obj.applyFilters();
    canvas.renderAll();
});


document.getElementById('exportImage').addEventListener('click', function() {
    var imageData = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
    var link = document.createElement('a');
    link.download = "edited-image.png";
    link.href = imageData;
    link.click();
});



var cropper;
document.getElementById('imageLoader').addEventListener('change', function (e) {
    var files = e.target.files;
    var done = function (url) {
        document.getElementById('image').src = url;
        document.getElementById('image').style.display = 'block';
        if (cropper) {
            cropper.destroy();
        }
        cropper = new Cropper(document.getElementById('image'), {
            viewMode: 1,
            autoCropArea: 1,
            movable: false,
            rotatable: false,
            scalable: false,
            zoomable: true,
            autoCrop: true,
            autoCropArea: 1,
            resizable: false,
            crop: function(event) {
                // Handle the crop event here
            }
        });
    };
    var reader;
    var file;
    var url;

    if (files && files.length > 0) {
        file = files[0];
        if (URL) {
            done(URL.createObjectURL(file));
        } else if (FileReader) {
            reader = new FileReader();
            reader.onload = function (e) {
                done(reader.result);
            };
            reader.readAsDataURL(file);
        }
    }
});

document.getElementById('size800x600').addEventListener('click', function() {
    canvas.setWidth(800);
    canvas.setHeight(600);
    canvas.renderAll();
});

document.getElementById('size1024x768').addEventListener('click', function() {
    canvas.setWidth(1024);
    canvas.setHeight(768);
    canvas.renderAll();
});

document.getElementById('customSize').addEventListener('click', function() {
    var width = document.getElementById('customWidth').value;
    var height = document.getElementById('customHeight').value;
    if (width > 0 && height > 0) {
        canvas.setWidth(width);
        canvas.setHeight(height);
        canvas.renderAll();
    } else {
        alert('الرجاء إدخال قيم صحيحة للعرض والارتفاع.');
    }
});



document.getElementById('cropImage').addEventListener('click', function() {
    if (!cropper) {
        alert('الرجاء تحميل صورة أولاً.');
        return;
    }
    // الحصول على الصورة المقصوصة كـ Blob
    cropper.getCroppedCanvas().toBlob(function(blob) {
        var reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = function() {
            var base64data = reader.result;
            var imgObj = new Image();
            imgObj.src = base64data;
            imgObj.onload = function() {
                var image = new fabric.Image(imgObj);
                image.set({
                    angle: 0,
                    padding: 10,
                    cornersize: 10,
                    height: imgObj.height,
                    width: imgObj.width,
                });
                canvas.clear();
                canvas.add(image);
                canvas.setActiveObject(image);
            }
        };
    });
});







canvas.on('mouse:down', function(options) {
    if (!options.target) {
        canvas.discardActiveObject().requestRenderAll();
    }
});







// زيادة حجم زوايا التحكم للتحديد والتدوير
fabric.Object.prototype.cornerSize = 20; // حجم زوايا التحكم
fabric.Object.prototype.rotatingPointOffset = 40; // مسافة نقطة التدوير من العنصر
fabric.Object.prototype.padding = 5; // إضافة هامش حول العناصر لتسهيل التحديد

// جعل خط التحديد أكثر وضوحًا
fabric.Object.prototype.borderOpacityWhenMoving = 1;
fabric.Object.prototype.borderColor = 'blue'; // لون الحدود
fabric.Object.prototype.cornerColor = 'blue'; // لون زوايا التحكم
fabric.Object.prototype.cornerStrokeColor = 'blue'; // لون حدود زوايا التحكم

// تغيير مؤشر الفأرة لتحسين التوجيه
fabric.Object.prototype.hoverCursor = 'pointer'; // مؤشر الفأرة عند التحويم

// تعديلات أخرى قد تكون مفيدة
fabric.Object.prototype.transparentCorners = false; // جعل زوايا التحكم غير شفافة
fabric.Object.prototype.hasBorders = true; // إظهار الحدود حول العناصر
fabric.Object.prototype.hasControls = true; // إظهار عناصر التحكم للتحديد والتدوير والتغيير في الحجم




fabric.Object.prototype.borderOpacityWhenMoving = 0.4;
fabric.Object.prototype.borderScaleFactor = .8; // تكبير حجم الحدود قليلاً للتأكيد عليها
 
WebFont.load({
    google: {
      families: ['Font Awesome 5 Free:900']
    },
    active: function() {
      // الخط جاهز للاستخدام، يمكنك الآن إنشاء canvas أو رسم الأيقونات
    }
  });



function renderIcon(ctx, icon, left, top, size) {
  ctx.font = `900 20px 'Font Awesome 5 Free'`;
  ctx.fillStyle = '#000';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(icon, left, top);
}

fabric.Object.prototype.controls.deleteControl = new fabric.Control({
  x: 0.5,
  y: -0.5,
  offsetY: -10,offsetX: 16,
  cursorStyle: 'pointer',
  mouseUpHandler: function(eventData, transform) {
    var target = transform.target;
    var canvas = target.canvas;
    canvas.remove(target);
    canvas.requestRenderAll();
  },
  render: function(ctx, left, top, styleOverride, fabricObject) {
    renderIcon(ctx, '\uf1f8', left, top, '20px'); // \uf1f8 is FontAwesome's trash icon
  },
  cornerSize: 24
});

fabric.Object.prototype.controls.clone = new fabric.Control({
  x: 0.5,
  y: -0.5,
  offsetY: 20,offsetX: 16,
  cursorStyle: 'pointer',
  mouseUpHandler: function(eventData, transform) {
    var target = transform.target;
    target.clone(function(cloned) {
      cloned.set({left: target.left + 10, top: target.top + 10});
      target.canvas.add(cloned);
    });
  },
  render: function(ctx, left, top, styleOverride, fabricObject) {
    renderIcon(ctx, '\uf0c5', left, top, '20px'); // \uf0c5 is FontAwesome's copy icon
  },
  cornerSize: 24
});


</script>
</body>
    </html>
